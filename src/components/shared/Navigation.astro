---
import Icon from "./Icon.astro";

const { pathname } = Astro.url;

const normalizePathname = (path: string) => path.replace(/\/$/, '') || '/';
const getIsLinkActive = (href: string) => !href.includes("#") && normalizePathname(pathname) === normalizePathname(href);

const navigationLinks = [
    { href: "/", label: "Главная" },
    { href: "/help", label: "С чем помогаю" },
    { href: "/price", label: "Стоимость" },
    { href: "/faq", label: "Вопросы" },
    { href: "/about", label: "Обо мне" },
    { href: "/articles", label: "Статьи" },
    { href: "/tests", label: "Тесты" },
    { href: "/education", label: "Образование" },
];
---

<button type="button" class="menu-button" aria-label="Меню" aria-expanded="false" aria-controls="menu">
    <span>Меню</span>
    <Icon name="menu" />
</button>
<nav id="menu" class="menu closed" aria-label="Главное меню">
    <ul class="nav-list">
        {
            navigationLinks.map((link) => {
                const isActive = getIsLinkActive(link.href);

                return (
                    <li class="nav-item">
                        <a class="nav-link" href={link.href} class:list={[{ active: isActive }]} aria-current={isActive ? "page" : undefined}>
                            {link.label}
                        </a>
                    </li>
                );
            })
        }
    </ul>
</nav>

<style>
    .menu-button {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0;
        border: none;
        margin: 0;
        background-color: transparent;
        cursor: pointer;
        font-size: 24px;
        line-height: 30px;
        color: var(--primary-color);
        text-transform: uppercase;

        @media (hover: hover) {
            &:hover {
                color: var(--hover-color);
            }
        }

        &:active,
        &[aria-expanded="true"] {
            color: var(--hover-color);
        }

        @media screen and (width >= 1138px) {
            display: none;
        }

        @media screen and (width < 800px) {
            font-size: 18px;
            line-height: 24px;
        }

        @media screen and (width < 600px) {
            span {
                display: none;
            }
        }
    }

    .menu {
        @media screen and (width < 1138px) {
            z-index: 1;
            position: fixed;
            inset: var(--header-height) 0 0;
            box-sizing: border-box;
            contain: layout;
            overflow-y: auto;
            padding: 20px;
            border-top: 2px solid var(--border-color);
            background-color: var(--secondary-color);

            @media (prefers-reduced-motion: no-preference) {
                transition:
                    opacity 0.3s ease,
                    transform 0.3s ease,
                    display 0.3s ease allow-discrete;

                @starting-style {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }

            &.closed {
                display: none;
                opacity: 0;
                transform: translateX(100%);
            }

            .nav-list {
                flex-direction: column;
                align-items: stretch;
                gap: 20px;
            }

            .nav-item {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .nav-link {
                box-sizing: border-box;
                width: 100%;
                max-width: 462px;
                padding: 20px;
                font-size: 22px;
                line-height: 30px;
                text-align: center;
            }
        }
    }

    .nav-list {
        display: flex;
        align-items: center;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .nav-link {
        display: block;
        padding: 8px 24px;
        font-size: 18px;
        line-height: 28px;
        color: var(--primary-color);
        white-space: nowrap;
        text-decoration: none;

        &:hover,
        &:active {
            color: var(--hover-color);
        }

        &:hover,
        &:active,
        &.active {
            text-decoration: underline;
        }
    }
</style>

<script>
    const main = document.querySelector('main');
    const footer = document.querySelector('footer');
    const menuButton = document.querySelector<HTMLButtonElement>('.menu-button');
    const menu = document.querySelector<HTMLElement>('.menu');

    function isMenuOpened(): boolean {
        return menuButton?.getAttribute('aria-expanded') === 'true';
    }

    function openMenu() {
        document.body.style.overflow = 'hidden';
        main?.setAttribute('inert', '');
        footer?.setAttribute('inert', '');
        menuButton?.setAttribute('aria-expanded', 'true');
        menu?.classList.remove('closed');
    }

    function closeMenu() {
        document.body.style.overflow = 'auto';
        main?.removeAttribute('inert');
        footer?.removeAttribute('inert');
        menuButton?.setAttribute('aria-expanded', 'false');
        menu?.classList.add('closed');
    }

    menuButton?.addEventListener('click', () => {
        isMenuOpened() ? closeMenu() : openMenu();
    });

    document.addEventListener('keyup', (event: KeyboardEvent) => {
        if (event.key === 'Escape' && isMenuOpened()) {
            closeMenu();
        }
    });

</script>
