---
const { pathname } = Astro.url;

const getIsLinkActive = (href: string) => !href.includes("#") && pathname === href;

const navigationLinks = [
    { href: "/", label: "Главная" },
    { href: "/#help", label: "С чем помогаю" },
    { href: "/#price", label: "Стоимость" },
    { href: "/#faq", label: "Вопросы" },
    { href: "/about", label: "Обо мне" },
    { href: "/articles", label: "Статьи" },
    { href: "/tests", label: "Тесты" },
    { href: "/education", label: "Образование" },
];
---

<button type="button" class="menu-button" aria-label="Меню" aria-expanded="false" aria-controls="menu">
    <span>Меню</span>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M20 17.5a1.5 1.5 0 0 1 .144 2.993L20 20.5H4a1.5 1.5 0 0 1-.144-2.993L4 17.5h16Zm0-7a1.5 1.5 0 1 1 0 3H4a1.5 1.5 0 1 1 0-3h16Zm0-7a1.5 1.5 0 0 1 0 3H4a1.5 1.5 0 0 1 0-3h16Z"/></svg>
</button>
<nav id="menu" class="menu closed" aria-label="Главное меню">
    <ul class="nav-list">
        {
            navigationLinks.map((link) => {
                const isActive = getIsLinkActive(link.href);

                return (
                    <li class="nav-item">
                        <a class="nav-link" href={link.href} class:list={[{ active: isActive }]} aria-current={isActive ? "page" : undefined}>
                            {link.label}
                        </a>
                    </li>
                );
            })
        }
    </ul>
</nav>

<style>
    .menu-button {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0;
        border: none;
        margin: 0;
        background-color: transparent;
        cursor: pointer;
        font-size: 24px;
        line-height: 30px;
        color: var(--primary-color);
        text-transform: uppercase;

        &:hover,
        &:active,
        &[aria-expanded="true"] {
            color: var(--hover-color);
        }

        @media screen and (width >= 1138px) {
            display: none;
        }

        @media screen and (width < 800px) {
            font-size: 18px;
            line-height: 24px;
        }

        @media screen and (width < 600px) {
            span {
                display: none;
            }
        }
    }

    .menu {
        @media screen and (width < 1138px) {
            position: absolute;
            top: var(--header-height);
            left: 0;
            right: 0;
            box-sizing: border-box;
            max-height: calc(100vh - var(--header-height));
            overflow-y: auto;
            padding: 20px;
            border-top: 2px solid var(--border-color);
            background-color: var(--secondary-color);

            &.closed {
                display: none;
            }

            .nav-list {
                flex-direction: column;
                align-items: stretch;
                gap: 20px;
            }

            .nav-item {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .nav-link {
                box-sizing: border-box;
                width: 100%;
                max-width: 462px;
                padding: 20px;
                font-size: 22px;
                line-height: 30px;
                text-align: center;
            }
        }
    }

    .nav-list {
        display: flex;
        align-items: center;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .nav-link {
        display: block;
        padding: 8px 24px;
        font-size: 18px;
        line-height: 28px;
        color: var(--primary-color);
        white-space: nowrap;
        text-decoration: none;

        &:hover,
        &:active {
            color: var(--hover-color);
        }

        &:hover,
        &:active,
        &.active {
            text-decoration: underline;
        }
    }
</style>

<script>
    import { throttle } from "../../utils/throttle.ts";

    const main = document.querySelector('main');
    const footer = document.querySelector('footer');
    const menuButton = document.querySelector('.menu-button');
    const menu = document.querySelector('.menu');

    menuButton?.addEventListener('click', () => {
        const isMenuOpen = menuButton.getAttribute('aria-expanded') === 'true';

        menuButton.setAttribute('aria-expanded', isMenuOpen ? 'false' : 'true');
        menu?.classList.toggle('closed');

        if (isMenuOpen) {
            document.body.style.overflow = 'hidden';
            main?.removeAttribute('inert');
            footer?.removeAttribute('inert');
        } else {
            document.body.style.overflow = 'auto';
            main?.setAttribute('inert', '');
            footer?.setAttribute('inert', '');
        }
    });

    if (window.location.pathname === '/') {
        const navLinks = document.querySelectorAll<HTMLAnchorElement>('.nav-link');
        const sections = document.querySelectorAll<HTMLElement>('section[id]');
        const header = document.querySelector<HTMLElement>('header');

        const SCROLL_OFFSET = 50;
        const THROTTLE_DELAY = 100;

        const getHeaderHeight = (): number => {
            if (!header) return 0;

            const cssVar = getComputedStyle(header).getPropertyValue('--header-height');
            if (cssVar) return parseInt(cssVar, 10);

            return header.offsetHeight;
        };

        const updateActiveLink = () => {
            const scrollY = window.scrollY;
            const headerHeight = getHeaderHeight();

            let currentSectionId = '';

            sections.forEach((section) => {
                const sectionTop = section.offsetTop - headerHeight - SCROLL_OFFSET;
                const sectionBottom = sectionTop + section.offsetHeight;

                if (scrollY >= sectionTop && scrollY < sectionBottom) {
                    currentSectionId = section.id;
                }
            });

            navLinks.forEach((link) => {
                const href = link.getAttribute('href');
                const isActive = href === `/#${currentSectionId}` || (currentSectionId === '' && href === '/');

                link.classList.toggle('active', isActive);
            });
        };

        updateActiveLink();
        window.addEventListener('scroll', throttle(updateActiveLink, THROTTLE_DELAY), { passive: true });
    }
</script>
